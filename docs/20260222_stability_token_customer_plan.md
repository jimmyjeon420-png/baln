# BALN 안정성/토큰효율/고객성과 통합 기획서

작성일: 2026-02-22 (KST)

## 1) 목표

이 계획의 목적은 아래 3가지를 동시에 달성하는 것이다.

1. 안정성: 앱/백엔드 실패율을 낮추고 장애 복구 시간을 줄인다.
2. 토큰 효율: Gemini/Supabase 비용을 줄이면서 품질은 유지 또는 향상한다.
3. 고객 성과: 사용자에게 더 신선하고 관련도 높은 결과를 제공해 리텐션/전환을 올린다.

## 2) 현재 상태 스냅샷 (레포 기준)

1. 앱 구조: `app/`, `src/`, `supabase/`가 명확히 분리되어 있고 기능 확장 폭이 큼.
2. Supabase 마이그레이션: `supabase/migrations` 67개로 증가, 운영 규율이 더 필요.
3. Edge Function: `daily-briefing` 중심 오케스트레이션(Task A~J), 기능 많고 결합도 높음.
4. CI 현황: `.github/workflows`는 배포 워크플로우 1개만 존재, 품질 게이트 CI 부족.
5. 타입 안정성: `@ts-nocheck` 16건으로 런타임 리스크/회귀 위험이 큼.
6. 실험 인프라: `src/config/experiments.ts`, `src/hooks/useABExperiment.ts` 존재(좋은 기반).

## 3) 핵심 KPI (12주 목표)

1. 앱 안정성
- Crash-free session: 99.5% -> 99.8%
- Edge Function 실패율(실패 응답/전체 실행): 5% 이하
- P95 뉴스 로드 시간: 2.5s 이하

2. 토큰/비용
- 사용자 1인당 일 토큰 사용량: 30% 절감
- Task별 토큰 사용량 분산: 상위 2개 Task 집중도 60% -> 40% 이하
- 불필요 AI 재호출률(동일 입력 재분석): 50% 감축

3. 고객 성과
- 실시간 뉴스 최신성(최근 24h 비율): 90% 이상 유지
- 개인화 관련도(자산 매칭 뉴스 CTR): +20%
- D7 리텐션: +10%

## 4) 실행 트랙

## 트랙 A. 안정성 (App + Supabase)

1. 품질 게이트 CI 도입
- PR마다 `eslint`, `tsc --noEmit`, 핵심 smoke test 실행
- 실패 시 main 병합 차단

2. Edge Function 보호장치 강화
- Task 실행 단위별 timeout, retry, idempotency key 표준화
- Task 실패가 전체 실패로 번지지 않게 상태 격리
- 실패 로그를 `edge_function_logs`에 표준 필드로 저장

3. 마이그레이션 운영 규율
- 마이그레이션 파일명 규칙 고정(UTC timestamp + 목적)
- 롤포워드 기준(undo 대신 fix migration) 원칙 문서화
- 스키마 변경 시 앱/함수 호환 기간을 명시

4. 타입 안정성 단계적 회복
- `@ts-nocheck` 제거 우선순위:
  1) `supabase/functions/daily-briefing/_shared.ts`
  2) `supabase/functions/daily-briefing/index.ts`
  3) `supabase/functions/daily-briefing/task-j-news.ts`

## 트랙 B. 토큰 효율 (AI/데이터 파이프라인)

1. Task별 토큰 예산제
- Task A/B/G/J에 일 예산(cap) 설정
- 예산 초과 시 저비용 폴백 경로 실행

2. 캐시 정책 강화
- 입력 해시 기반 결과 캐시(요청 prompt hash + 핵심 파라미터)
- TTL 차등 적용:
  - 뉴스 태깅: 30~60분
  - 거시 분석: 3~6시간
  - 맥락 카드: timeslot 단위

3. 모델 라우팅
- 기본: 경량 모델
- 고비용 모델은 “품질 임계치 미달 시 2차 호출” 방식으로 제한

4. 프롬프트 표준화
- Task별 prompt template 버전 관리(`prompt_version`)
- JSON 응답 스키마 고정 + strict parser
- 출력 길이 상한, 필드별 글자수 상한 강제

5. 중복 호출 제거
- 동일 사용자/동일 데이터셋에 대한 연속 호출 디바운스
- 스케줄 중복 실행 방지 락(예: advisory lock/redis-like key in db)

## 트랙 C. 고객 가치 (결과 품질/UX)

1. 뉴스 품질 점수화
- 최신성(가중치 50) + 자산 관련도(30) + 출처 신뢰(20)
- 점수 기준 미달 뉴스는 하단 노출 또는 비노출

2. 개인화 강화
- 보유 자산 태그 매칭을 티커/동의어/국문명까지 확장
- 관련도 높은 뉴스만 push/요약 우선순위 부여

3. 설명 품질 개선
- 영향도 문구는 사실/추정 분리 표현
- 링크 기반 원문 우선 구조 유지(법적 리스크 최소화)

4. 실험 운영 고도화
- 주 1개 실험 원칙 유지
- 매주 월요일 실험 설정, 일요일 결과 리뷰
- 실험 실패 기준(guardrail metric) 사전 정의

## 5) 12주 실행 로드맵

## Phase 0 (1주): 계측/가드레일

1. CI 워크플로우 추가
2. KPI 대시보드 SQL 뷰 생성(실패율/토큰/최신성)
3. Edge Function 로그 스키마 표준화
4. 운영 런북 초안 작성

완료 기준:
- PR마다 자동 검사 동작
- 일일 지표를 SQL로 조회 가능

## Phase 1 (2~4주): 안정성 우선

1. `@ts-nocheck` 우선 3개 제거
2. daily-briefing Task별 timeout/재시도 통일
3. cron 중복 실행 방지 락 적용
4. 뉴스/맥락 카드 핵심 경로 회귀 테스트 추가

완료 기준:
- 주요 Task 실패율 50% 감소
- 장애 재현/복구 절차 문서화 완료

## Phase 2 (5~8주): 토큰 절감

1. Task별 토큰 예산 캡 도입
2. prompt hash 캐시 도입
3. 모델 라우팅(저비용->고비용 2단계) 적용
4. 중복 호출 디바운스 적용

완료 기준:
- 일 토큰 사용량 20% 이상 절감
- 품질 지표(CTR, 최신성) 하락 없음

## Phase 3 (9~12주): 고객 성과 최적화

1. 뉴스 품질 점수 랭킹 적용
2. 자산 영향도 문구 품질 개선(추정/사실 분리)
3. A/B 실험 자동 리포트 주간 발행
4. D7 리텐션/유료 전환 개선 반복

완료 기준:
- D7 리텐션 +10%, 자산매칭 CTR +20%

## 6) Git 운영 방식

1. 브랜치 규칙
- 기능: `codex/feature-*`
- 핫픽스: `codex/hotfix-*`
- 리팩터링: `codex/refactor-*`

2. PR 규칙
- 300줄 이상 변경 시 설계 요약 필수
- DB 변경 포함 PR은 “마이그레이션 영향” 섹션 필수
- 체크리스트: lint/typecheck/test/supabase deploy plan

3. 릴리즈 규칙
- 주 2회 정기 릴리즈 + 긴급 핫픽스
- 릴리즈 노트에 KPI 영향 예상/실측 포함

## 7) Supabase 운영 방식

1. 함수 배포
- 기능별 개별 deploy, 배포 직후 selective task smoke 실행
- 실패 시 즉시 이전 안전 버전으로 롤포워드 패치

2. 마이그레이션
- 신규 컬럼은 기본값/nullable로 시작(하위호환)
- 앱 릴리즈 후 NOT NULL/강제 제약 전환

3. 데이터 보호
- RLS 변경 시 테스트 쿼리 세트로 사전 검증
- 제3자 데이터는 출처/링크 우선 원칙 유지

## 8) 운영 리듬 (지속 실행 방법)

1. 매일
- 오전: 전일 장애/실패율/토큰량 점검 (15분)
- 오후: 고객 지표(CTR/리텐션) 점검 (15분)

2. 매주
- 월: 실험 시작 + 우선순위 선정
- 수: 중간 점검(지표/리스크)
- 금: 회고 + 다음주 계획 확정

3. 매월
- KPI 달성률 리뷰
- 고비용 Task 재설계 대상 선정

## 9) 바로 시작할 백로그 (우선순위)

P0
1. CI 워크플로우 추가(`lint`, `tsc`, 핵심 테스트)
2. `daily-briefing` 실행 메트릭 테이블/뷰 정비
3. `@ts-nocheck` 우선 3개 제거 시작

P1
1. Prompt hash 캐시 추가
2. Task별 토큰 cap + 알람
3. 뉴스 품질 스코어 계산 함수 도입

P2
1. A/B 자동 결과 리포트 함수
2. 개인화 태그 사전 확장
3. 고객 피드백(좋아요/도움됨) 루프 연결

---

이 문서를 기준으로 다음 액션은 “P0 3개를 1주 내 완료”로 고정한다.
