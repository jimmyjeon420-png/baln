<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>baln Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <style>
    :root {
      --bg: #0D0D0D;
      --surface: #1A1A1A;
      --surface2: #242424;
      --border: #333;
      --text: #F5F5F5;
      --text2: #9E9E9E;
      --text3: #666;
      --green: #4CAF50;
      --green-dim: rgba(76, 175, 80, 0.15);
      --red: #CF6679;
      --yellow: #FFC107;
      --blue: #2196F3;
      --purple: #9C27B0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ Login Screen â”€â”€ */
    #login-screen {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-card {
      background: var(--surface);
      border-radius: 16px;
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .login-card h1 {
      font-size: 24px;
      margin-bottom: 8px;
      color: var(--green);
    }

    .login-card p {
      color: var(--text2);
      margin-bottom: 24px;
      font-size: 14px;
    }

    .login-card input {
      width: 100%;
      padding: 12px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      margin-bottom: 12px;
      outline: none;
    }

    .login-card input:focus {
      border-color: var(--green);
    }

    .login-card button {
      width: 100%;
      padding: 14px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .login-card button:hover { opacity: 0.9; }
    .login-card button:disabled { opacity: 0.5; cursor: not-allowed; }

    .login-error {
      color: var(--red);
      font-size: 13px;
      margin-top: 8px;
    }

    /* â”€â”€ Dashboard Layout â”€â”€ */
    #dashboard { display: none; }

    .topbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .topbar h1 {
      font-size: 18px;
      color: var(--green);
    }

    .topbar .badge {
      background: var(--green-dim);
      color: var(--green);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .refresh-btn, .logout-btn {
      padding: 8px 16px;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      border: none;
      transition: opacity 0.2s;
    }

    .refresh-btn {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .logout-btn {
      background: rgba(207, 102, 121, 0.15);
      color: var(--red);
    }

    .refresh-btn:hover, .logout-btn:hover { opacity: 0.8; }

    /* â”€â”€ Tab Navigation â”€â”€ */
    .tab-nav {
      display: flex;
      gap: 4px;
      padding: 12px 24px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      overflow-x: auto;
    }

    .tab-btn {
      padding: 8px 16px;
      border-radius: 8px;
      background: transparent;
      color: var(--text2);
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .tab-btn.active {
      background: var(--green-dim);
      color: var(--green);
    }

    .tab-btn:hover:not(.active) {
      background: var(--surface2);
    }

    /* â”€â”€ Content Area â”€â”€ */
    .content {
      padding: 24px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* â”€â”€ Cards Grid â”€â”€ */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .metric-card {
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border);
    }

    .metric-label {
      font-size: 12px;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .metric-value {
      font-size: 28px;
      font-weight: 700;
    }

    .metric-sub {
      font-size: 12px;
      color: var(--text3);
      margin-top: 4px;
    }

    .metric-value.green { color: var(--green); }
    .metric-value.blue { color: var(--blue); }
    .metric-value.yellow { color: var(--yellow); }
    .metric-value.red { color: var(--red); }
    .metric-value.purple { color: var(--purple); }

    /* â”€â”€ Section Cards â”€â”€ */
    .section-card {
      background: var(--surface);
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .section-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
    }

    .section-body {
      padding: 20px;
    }

    /* â”€â”€ Data Table â”€â”€ */
    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .data-table th {
      text-align: left;
      padding: 10px 12px;
      color: var(--text2);
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid var(--border);
    }

    .data-table td {
      padding: 10px 12px;
      border-bottom: 1px solid rgba(51, 51, 51, 0.5);
    }

    .data-table tr:hover td {
      background: rgba(76, 175, 80, 0.05);
    }

    .tier-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 600;
    }

    .tier-free { background: rgba(158, 158, 158, 0.2); color: #9E9E9E; }
    .tier-premium { background: rgba(255, 193, 7, 0.2); color: #FFC107; }

    /* â”€â”€ Chart Container â”€â”€ */
    .chart-container {
      position: relative;
      height: 300px;
      padding: 10px;
    }

    /* â”€â”€ Search Box â”€â”€ */
    .search-box {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
    }

    .search-box input {
      flex: 1;
      padding: 10px 16px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .search-box input:focus {
      border-color: var(--green);
    }

    /* â”€â”€ Loading Spinner â”€â”€ */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid var(--border);
      border-top-color: var(--green);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .loading-overlay {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      gap: 12px;
      color: var(--text2);
    }

    /* â”€â”€ Responsive â”€â”€ */
    @media (max-width: 768px) {
      .content { padding: 16px; }
      .metrics-grid { grid-template-columns: repeat(2, 1fr); }
      .metric-value { font-size: 22px; }
    }

    /* â”€â”€ Empty State â”€â”€ */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text3);
    }

    .empty-state p {
      font-size: 14px;
    }

    /* â”€â”€ Last Updated â”€â”€ */
    .last-updated {
      font-size: 11px;
      color: var(--text3);
    }

    /* â”€â”€ Delta Indicator â”€â”€ */
    .metric-delta { font-size: 12px; margin-top: 4px; font-weight: 600; }
    .metric-delta.up { color: var(--green); }
    .metric-delta.down { color: var(--red); }
    .metric-delta.flat { color: var(--text3); }

    /* â”€â”€ Filter Chips â”€â”€ */
    .filter-chips { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .filter-chip {
      padding: 6px 14px; border-radius: 20px; background: var(--surface2);
      border: 1px solid var(--border); color: var(--text2); font-size: 13px;
      cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px;
    }
    .filter-chip.active { background: var(--green-dim); border-color: var(--green); color: var(--green); }
    .filter-chip:hover:not(.active) { border-color: var(--text3); }
    .count-badge { background: var(--surface); padding: 1px 6px; border-radius: 8px; font-size: 11px; font-weight: 600; }

    /* â”€â”€ Modal â”€â”€ */
    .modal-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.7); z-index: 1000; display: flex;
      align-items: center; justify-content: center; padding: 20px;
      opacity: 0; visibility: hidden; transition: all 0.2s;
    }
    .modal-overlay.visible { opacity: 1; visibility: visible; }
    .modal-card {
      background: var(--surface); border-radius: 16px; border: 1px solid var(--border);
      width: 100%; max-width: 640px; max-height: 80vh; overflow-y: auto;
    }
    .modal-header {
      padding: 20px 24px; border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      position: sticky; top: 0; background: var(--surface); z-index: 1;
    }
    .modal-header h3 { font-size: 18px; }
    .modal-close { background: none; border: none; color: var(--text2); font-size: 24px; cursor: pointer; padding: 4px 8px; }
    .modal-close:hover { color: var(--text); }
    .modal-body { padding: 24px; }
    .modal-section { margin-bottom: 20px; }
    .modal-section-title { font-size: 12px; color: var(--text2); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }

    /* â”€â”€ Segment Control â”€â”€ */
    .segment-control { display: inline-flex; background: var(--surface2); border-radius: 10px; padding: 3px; margin-bottom: 16px; }
    .segment-btn { padding: 8px 20px; border-radius: 8px; border: none; background: transparent; color: var(--text2); font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .segment-btn.active { background: var(--green-dim); color: var(--green); }

    /* â”€â”€ Summary Banner â”€â”€ */
    .summary-banner { background: var(--surface2); border-radius: 10px; padding: 12px 20px; margin-bottom: 16px; display: flex; gap: 24px; font-size: 13px; color: var(--text2); }
    .summary-banner strong { color: var(--text); }

    /* â”€â”€ Status Dot â”€â”€ */
    .status-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .status-dot.green { background: var(--green); }
    .status-dot.yellow { background: var(--yellow); }
    .status-dot.gray { background: var(--text3); }
    .status-dot.red { background: var(--red); }

    /* â”€â”€ Retention Bars â”€â”€ */
    .retention-bar { margin-bottom: 16px; }
    .retention-bar label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; }
    .retention-bar label span:first-child { color: var(--text2); }
    .retention-bar label span:last-child { font-weight: 600; }
    .retention-track { height: 28px; background: var(--surface2); border-radius: 6px; overflow: hidden; }
    .retention-fill { height: 100%; border-radius: 6px; transition: width 0.6s; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; font-size: 11px; font-weight: 600; color: white; min-width: 36px; }

    /* â”€â”€ Post Card â”€â”€ */
    .post-card { background: var(--surface2); border-radius: 10px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border); }
    .post-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
    .post-card-meta { font-size: 12px; color: var(--text3); }
    .post-card-content { font-size: 14px; color: var(--text); margin-bottom: 12px; line-height: 1.5; }
    .post-card-content.collapsed { max-height: 60px; overflow: hidden; }
    .post-actions { display: flex; gap: 8px; }

    /* â”€â”€ Action Buttons â”€â”€ */
    .action-btn { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border); background: var(--surface); color: var(--text2); transition: all 0.2s; }
    .action-btn:hover { border-color: var(--text3); color: var(--text); }
    .action-btn.danger { border-color: rgba(207,102,121,0.3); color: var(--red); }
    .action-btn.danger:hover { background: rgba(207,102,121,0.1); }
    .action-btn.success { border-color: rgba(76,175,80,0.3); color: var(--green); }
    .action-btn.success:hover { background: rgba(76,175,80,0.1); }
    .action-btn.primary { background: var(--green); color: white; border-color: var(--green); }
    .action-btn.primary:hover { opacity: 0.9; }

    /* â”€â”€ Urgent Badge â”€â”€ */
    .urgent-badge { display: inline-block; background: rgba(207,102,121,0.2); color: var(--red); font-size: 11px; font-weight: 700; padding: 2px 6px; border-radius: 4px; margin-left: 6px; }

    /* â”€â”€ Clickable Row â”€â”€ */
    .data-table tr.clickable { cursor: pointer; }
    .data-table tr.clickable:hover td { background: rgba(76,175,80,0.08); }

    /* â”€â”€ Bulk Action Bar â”€â”€ */
    .bulk-action-bar { position: sticky; bottom: 0; background: var(--surface); border-top: 1px solid var(--border); padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; }
    .bulk-action-bar.hidden { display: none; }

    /* â”€â”€ Modal Form â”€â”€ */
    .modal-input { width: 100%; padding: 10px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; outline: none; margin-bottom: 8px; }
    .modal-input:focus { border-color: var(--green); }
    .modal-textarea { width: 100%; padding: 10px 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 14px; outline: none; resize: vertical; min-height: 60px; margin-bottom: 8px; }
    .modal-textarea:focus { border-color: var(--green); }

    /* â”€â”€ Info Grid â”€â”€ */
    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .info-label { font-size: 11px; color: var(--text3); margin-bottom: 2px; }
    .info-value { font-size: 14px; font-weight: 500; }

    /* â”€â”€ Checkbox â”€â”€ */
    .checkbox-cell { width: 40px; text-align: center; }
    .checkbox-cell input { accent-color: var(--green); }

    /* â”€â”€ Activity Feed â”€â”€ */
    .feed-group { margin-bottom: 16px; }
    .feed-group-label { font-size: 11px; color: var(--text3); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
    .feed-item { display: flex; gap: 10px; padding: 6px 0; font-size: 13px; }
    .feed-time { color: var(--text3); white-space: nowrap; min-width: 60px; }
    .feed-event { color: var(--text2); }
    .feed-event strong { color: var(--text); font-weight: 500; }
  </style>
</head>
<body>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- LOGIN SCREEN                                                -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="login-screen">
    <div class="login-card">
      <h1>baln Admin</h1>
      <p>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œì— ì ‘ì†í•©ë‹ˆë‹¤</p>
      <input type="url" id="supabase-url" placeholder="Supabase URL (https://xxx.supabase.co)" />
      <input type="password" id="service-key" placeholder="Service Role Key" />
      <button onclick="handleLogin()" id="login-btn">ë¡œê·¸ì¸</button>
      <p class="login-error" id="login-error"></p>
      <p style="margin-top:16px; font-size:11px; color:var(--text3);">
        Supabase Dashboard &gt; Settings &gt; API ì—ì„œ<br/>service_role keyë¥¼ ë³µì‚¬í•˜ì„¸ìš”
      </p>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- DASHBOARD                                                    -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="dashboard">
    <!-- Top Bar -->
    <div class="topbar">
      <div class="topbar-left">
        <h1>baln Admin</h1>
        <span class="badge" id="env-badge">Production</span>
        <span class="last-updated" id="last-updated"></span>
      </div>
      <div class="topbar-right">
        <button class="refresh-btn" onclick="refreshAll()">
          <span id="refresh-icon">&#x21BB;</span> ìƒˆë¡œê³ ì¹¨
        </button>
        <button class="logout-btn" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
      <button class="tab-btn active" data-tab="overview">Overview</button>
      <button class="tab-btn" data-tab="users">ìœ ì € ê´€ë¦¬</button>
      <button class="tab-btn" data-tab="credits">í¬ë ˆë”§ ê²½ì œ</button>
      <button class="tab-btn" data-tab="reports">ì‹ ê³  ê´€ë¦¬</button>
      <button class="tab-btn" data-tab="lounge">ë¼ìš´ì§€ ê´€ë¦¬</button>
      <button class="tab-btn" data-tab="engagement">ì¸ê²Œì´ì§€ë¨¼íŠ¸</button>
      <button class="tab-btn" data-tab="content">ì½˜í…ì¸ </button>
      <button class="tab-btn" data-tab="analytics">ë¶„ì„</button>
      <button class="tab-btn" data-tab="eventlog">ì´ë²¤íŠ¸ ë¡œê·¸</button>
    </div>

    <div class="content">

      <!-- â•â•â• TAB: OVERVIEW â•â•â• -->
      <div class="tab-content active" id="tab-overview">
        <div class="metrics-grid" id="overview-metrics">
          <div class="loading-overlay"><div class="spinner"></div> ë°ì´í„° ë¡œë”© ì¤‘...</div>
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="section-card">
            <div class="section-header"><span class="section-title">ì¼ë³„ ê°€ì…ì ì¶”ì´</span></div>
            <div class="section-body"><div class="chart-container"><canvas id="chart-signups"></canvas></div></div>
          </div>
          <div class="section-card">
            <div class="section-header"><span class="section-title">í¬ë ˆë”§ íë¦„ (ì§€ê¸‰ vs ì†Œë¹„)</span></div>
            <div class="section-body"><div class="chart-container"><canvas id="chart-credits"></canvas></div></div>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: USERS â•â•â• -->
      <div class="tab-content" id="tab-users">
        <div class="search-box">
          <input type="text" id="user-search" placeholder="ì´ë©”ì¼ ë˜ëŠ” IDë¡œ ê²€ìƒ‰..." oninput="searchUsers(this.value)" />
        </div>
        <div class="filter-chips" id="user-sort-chips">
          <button class="filter-chip active" data-sort="recent">ìµœê·¼í™œë™ìˆœ</button>
          <button class="filter-chip" data-sort="assets">ìì‚°ìˆœ</button>
          <button class="filter-chip" data-sort="credits">í¬ë ˆë”§ìˆœ</button>
          <button class="filter-chip" data-sort="created">ê°€ì…ì¼ìˆœ</button>
        </div>
        <div class="section-card">
          <div class="section-header">
            <span class="section-title">ì „ì²´ ìœ ì € (<span id="user-count">0</span>ëª…)</span>
          </div>
          <div class="section-body" style="padding:0; overflow-x:auto;">
            <table class="data-table" id="users-table">
              <thead>
                <tr>
                  <th>ìƒíƒœ</th>
                  <th>ê°€ì…ì¼</th>
                  <th>ì´ë©”ì¼</th>
                  <th>í”Œëœ</th>
                  <th>í¬ë ˆë”§</th>
                  <th>ìŠ¤íŠ¸ë¦­</th>
                  <th>ì˜ˆì¸¡ ì ì¤‘ë¥ </th>
                  <th>ìì‚° ê·œëª¨</th>
                </tr>
              </thead>
              <tbody id="users-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: CREDITS â•â•â• -->
      <div class="tab-content" id="tab-credits">
        <div class="metrics-grid" id="credit-metrics"></div>
        <div class="section-card">
          <div class="section-header">
            <span class="section-title">ìµœê·¼ í¬ë ˆë”§ ê±°ë˜</span>
          </div>
          <div class="section-body" style="padding:0; overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ì‹œê°„</th>
                  <th>ìœ ì €</th>
                  <th>ìœ í˜•</th>
                  <th>ê¸ˆì•¡</th>
                  <th>ì”ì•¡</th>
                  <th>ê¸°ëŠ¥</th>
                </tr>
              </thead>
              <tbody id="credits-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: REPORTS â•â•â• -->
      <div class="tab-content" id="tab-reports">
        <div class="filter-chips" id="report-filters">
          <button class="filter-chip active" data-filter="all">ì „ì²´ <span class="count-badge" id="report-count-all">0</span></button>
          <button class="filter-chip" data-filter="pending">ëŒ€ê¸° <span class="count-badge" id="report-count-pending">0</span></button>
          <button class="filter-chip" data-filter="resolved">ì²˜ë¦¬ <span class="count-badge" id="report-count-resolved">0</span></button>
          <button class="filter-chip" data-filter="rejected">ê±°ë¶€ <span class="count-badge" id="report-count-rejected">0</span></button>
        </div>
        <div class="summary-banner" id="report-summary"></div>
        <div class="section-card">
          <div class="section-body" style="padding:0; overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ì‹œê°„</th>
                  <th>ì‹ ê³ ì</th>
                  <th>ëŒ€ìƒ</th>
                  <th>ì‚¬ìœ </th>
                  <th>ìƒíƒœ</th>
                  <th>ê¸´ê¸‰</th>
                  <th>ì•¡ì…˜</th>
                </tr>
              </thead>
              <tbody id="reports-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: LOUNGE â•â•â• -->
      <div class="tab-content" id="tab-lounge">
        <div class="segment-control" id="lounge-segment">
          <button class="segment-btn active" data-segment="posts">ê²Œì‹œê¸€ (<span id="lounge-post-count">0</span>)</button>
          <button class="segment-btn" data-segment="gatherings">ëª¨ì„ (<span id="lounge-gathering-count">0</span>)</button>
        </div>
        <div class="filter-chips" id="lounge-filters">
          <button class="filter-chip active" data-filter="all">ì „ì²´</button>
          <button class="filter-chip" data-filter="pinned">ê³ ì •ë¨</button>
          <button class="filter-chip" data-filter="reported">ì‹ ê³ ë¨</button>
        </div>
        <div id="lounge-content">
          <div class="loading-overlay"><div class="spinner"></div> ë¡œë”© ì¤‘...</div>
        </div>
        <div class="bulk-action-bar hidden" id="bulk-actions">
          <span id="bulk-count">0ê°œ ì„ íƒ</span>
          <div style="display:flex;gap:8px;">
            <button class="action-btn success" onclick="bulkPin()">ì¼ê´„ ê³ ì •</button>
            <button class="action-btn danger" onclick="bulkDelete()">ì¼ê´„ ì‚­ì œ</button>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: ENGAGEMENT â•â•â• -->
      <div class="tab-content" id="tab-engagement">
        <div class="metrics-grid" id="engagement-metrics"></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="section-card">
            <div class="section-header"><span class="section-title">ì˜ˆì¸¡ ê²Œì„ ì°¸ì—¬</span></div>
            <div class="section-body"><div class="chart-container"><canvas id="chart-predictions"></canvas></div></div>
          </div>
          <div class="section-card">
            <div class="section-header"><span class="section-title">ìŠ¤íŠ¸ë¦­ ë¶„í¬</span></div>
            <div class="section-body"><div class="chart-container"><canvas id="chart-streaks"></canvas></div></div>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: CONTENT â•â•â• -->
      <div class="tab-content" id="tab-content">
        <div class="metrics-grid" id="content-metrics"></div>
        <div class="section-card">
          <div class="section-header">
            <span class="section-title">ìµœê·¼ ë§¥ë½ ì¹´ë“œ</span>
          </div>
          <div class="section-body" style="padding:0; overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ë‚ ì§œ</th>
                  <th>í—¤ë“œë¼ì¸</th>
                  <th>ê°ì •</th>
                  <th>ì¡°íšŒìˆ˜</th>
                </tr>
              </thead>
              <tbody id="context-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: ANALYTICS (Enhanced) â•â•â• -->
      <div class="tab-content" id="tab-analytics">
        <div class="section-card">
          <div class="section-header"><span class="section-title">ë¦¬í…ì…˜</span></div>
          <div class="section-body" id="retention-bars">
            <div class="loading-overlay"><div class="spinner"></div> ê³„ì‚° ì¤‘...</div>
          </div>
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <div class="section-card">
            <div class="section-header"><span class="section-title">7ì¼ íŠ¸ë Œë“œ (ê°€ì… + DAU)</span></div>
            <div class="section-body"><div class="chart-container"><canvas id="chart-trend"></canvas></div></div>
          </div>
          <div class="section-card">
            <div class="section-header"><span class="section-title">ìœ ì € ë¶„í¬</span></div>
            <div class="section-body">
              <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;">
                <div><div class="chart-container" style="height:180px;"><canvas id="chart-tier-dist"></canvas></div><div style="text-align:center;font-size:11px;color:var(--text3);">í‹°ì–´</div></div>
                <div><div class="chart-container" style="height:180px;"><canvas id="chart-plan-dist"></canvas></div><div style="text-align:center;font-size:11px;color:var(--text3);">í”Œëœ</div></div>
                <div><div class="chart-container" style="height:180px;"><canvas id="chart-asset-dist"></canvas></div><div style="text-align:center;font-size:11px;color:var(--text3);">ìì‚° êµ¬ê°„</div></div>
              </div>
            </div>
          </div>
        </div>
        <div class="section-card">
          <div class="section-header"><span class="section-title">í™œë™ í”¼ë“œ</span></div>
          <div class="section-body" id="activity-feed">
            <div class="loading-overlay"><div class="spinner"></div> ë¡œë”© ì¤‘...</div>
          </div>
        </div>
      </div>

      <!-- â•â•â• TAB: EVENT LOG â•â•â• -->
      <div class="tab-content" id="tab-eventlog">
        <div class="section-card">
          <div class="section-header">
            <span class="section-title">ìµœê·¼ ì´ë²¤íŠ¸ ë¡œê·¸ (100ê±´)</span>
          </div>
          <div class="section-body" style="padding:0; overflow-x:auto;">
            <table class="data-table">
              <thead>
                <tr>
                  <th>ì‹œê°„</th>
                  <th>ìœ ì €</th>
                  <th>ì´ë²¤íŠ¸</th>
                  <th>ì†ì„±</th>
                </tr>
              </thead>
              <tbody id="eventlog-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </div>

    <!-- â•â•â• MODALS â•â•â• -->
    <div class="modal-overlay" id="modal-user-detail">
      <div class="modal-card">
        <div class="modal-header">
          <h3 id="modal-user-name">ìœ ì € ìƒì„¸</h3>
          <button class="modal-close" onclick="hideModal('modal-user-detail')">&times;</button>
        </div>
        <div class="modal-body" id="modal-user-body">
          <div class="loading-overlay"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="modal-report-detail">
      <div class="modal-card">
        <div class="modal-header">
          <h3>ì‹ ê³  ìƒì„¸</h3>
          <button class="modal-close" onclick="hideModal('modal-report-detail')">&times;</button>
        </div>
        <div class="modal-body" id="modal-report-body">
          <div class="loading-overlay"><div class="spinner"></div></div>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="modal-credit-grant">
      <div class="modal-card">
        <div class="modal-header">
          <h3>í¬ë ˆë”§ ì§€ê¸‰</h3>
          <button class="modal-close" onclick="hideModal('modal-credit-grant')">&times;</button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="credit-grant-user-id" />
          <div class="modal-section">
            <div class="modal-section-title">ëŒ€ìƒ ìœ ì €</div>
            <div id="credit-grant-user-info" style="font-size:14px;"></div>
          </div>
          <div class="modal-section">
            <div class="modal-section-title">ì§€ê¸‰ ê¸ˆì•¡</div>
            <input type="number" class="modal-input" id="credit-grant-amount" placeholder="í¬ë ˆë”§ ìˆ˜ëŸ‰ (ì˜ˆ: 10)" min="1" />
          </div>
          <div class="modal-section">
            <div class="modal-section-title">ë©”ëª¨</div>
            <textarea class="modal-textarea" id="credit-grant-memo" placeholder="ì§€ê¸‰ ì‚¬ìœ  (ì„ íƒ)"></textarea>
          </div>
          <button class="action-btn primary" onclick="executeGrantCredit()" style="width:100%;padding:12px;">ì§€ê¸‰í•˜ê¸°</button>
        </div>
      </div>
    </div>

  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- JAVASCRIPT                                                   -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <script>
    let sb = null;
    let allUsers = [];
    let allReports = [];
    let allPosts = [];
    let allGatherings = [];
    let charts = {};
    let tabDataLoaded = {};
    let selectedPosts = new Set();
    let currentLoungeSegment = 'posts';
    let currentReportFilter = 'all';
    let currentUserSort = 'recent';

    // â”€â”€ Init â”€â”€
    window.addEventListener('DOMContentLoaded', () => {
      const saved = localStorage.getItem('baln_admin_creds');
      if (saved) {
        try {
          const { url, key } = JSON.parse(saved);
          document.getElementById('supabase-url').value = url;
          document.getElementById('service-key').value = key;
          handleLogin();
        } catch { /* ignore */ }
      }

      // Tab switching with lazy load
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
          btn.classList.add('active');
          document.getElementById(`tab-${btn.dataset.tab}`).classList.add('active');
          const tab = btn.dataset.tab;
          if (!tabDataLoaded[tab]) {
            tabDataLoaded[tab] = true;
            loadTabData(tab);
          }
        });
      });

      // User sort chips
      document.querySelectorAll('#user-sort-chips .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('#user-sort-chips .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          currentUserSort = chip.dataset.sort;
          sortAndRenderUsers();
        });
      });

      // Report filter chips
      document.querySelectorAll('#report-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('#report-filters .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          currentReportFilter = chip.dataset.filter;
          renderReportsTable();
        });
      });

      // Lounge segment control
      document.querySelectorAll('#lounge-segment .segment-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('#lounge-segment .segment-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          currentLoungeSegment = btn.dataset.segment;
          document.getElementById('lounge-filters').style.display = currentLoungeSegment === 'posts' ? 'flex' : 'none';
          renderLoungeContent();
        });
      });

      // Lounge filter chips
      document.querySelectorAll('#lounge-filters .filter-chip').forEach(chip => {
        chip.addEventListener('click', () => {
          document.querySelectorAll('#lounge-filters .filter-chip').forEach(c => c.classList.remove('active'));
          chip.classList.add('active');
          renderLoungeContent();
        });
      });

      // Modal: ESC to close, overlay click to close
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-overlay.visible').forEach(m => hideModal(m.id));
        }
      });
      document.querySelectorAll('.modal-overlay').forEach(overlay => {
        overlay.addEventListener('click', e => {
          if (e.target === overlay) hideModal(overlay.id);
        });
      });
    });

    function loadTabData(tab) {
      switch(tab) {
        case 'users': loadUsers(); break;
        case 'credits': loadCredits(); break;
        case 'reports': loadReports(); break;
        case 'lounge': loadLoungePosts(); loadGatherings(); break;
        case 'engagement': loadEngagement(); break;
        case 'content': loadContent(); break;
        case 'analytics': loadEnhancedAnalytics(); break;
        case 'eventlog': loadEventLog(); break;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTH
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function handleLogin() {
      const url = document.getElementById('supabase-url').value.trim();
      const key = document.getElementById('service-key').value.trim();
      const errEl = document.getElementById('login-error');
      const btn = document.getElementById('login-btn');
      if (!url || !key) { errEl.textContent = 'URLê³¼ Service Keyë¥¼ ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.'; return; }
      btn.disabled = true; btn.textContent = 'ì—°ê²° ì¤‘...'; errEl.textContent = '';
      try {
        sb = window.supabase.createClient(url, key, { auth: { autoRefreshToken: false, persistSession: false } });
        const { error } = await sb.from('profiles').select('*', { count: 'exact', head: true });
        if (error) throw error;
        localStorage.setItem('baln_admin_creds', JSON.stringify({ url, key }));
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
        refreshAll();
      } catch (err) {
        errEl.textContent = `ì—°ê²° ì‹¤íŒ¨: ${err.message || 'í‚¤ë¥¼ í™•ì¸í•˜ì„¸ìš”'}`;
      } finally { btn.disabled = false; btn.textContent = 'ë¡œê·¸ì¸'; }
    }

    function handleLogout() {
      localStorage.removeItem('baln_admin_creds');
      sb = null;
      document.getElementById('dashboard').style.display = 'none';
      document.getElementById('login-screen').style.display = 'flex';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REFRESH â€” Overview only (lazy load rest)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function refreshAll() {
      document.getElementById('last-updated').textContent = `ë§ˆì§€ë§‰ ê°±ì‹ : ${new Date().toLocaleTimeString('ko')}`;
      tabDataLoaded = { overview: true };
      await loadOverview();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OVERVIEW (Enhanced with deltas)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadOverview() {
      try {
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString();
        const yesterdayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1).toISOString();

        const [
          { count: totalUsers },
          { count: premiumUsers },
          { data: credits },
          { data: recentSignups },
          { count: todayDAU },
          { count: yesterdayDAU },
          { count: todaySignups },
          { count: yesterdaySignups },
          { count: todayVotes },
          { count: yesterdayVotes },
          { count: todayPostCount },
          { count: yesterdayPostCount },
          { data: todayCreditTx },
          { data: yesterdayCreditTx },
          { data: creditTx },
        ] = await Promise.all([
          sb.from('profiles').select('*', { count: 'exact', head: true }),
          sb.from('profiles').select('*', { count: 'exact', head: true }).neq('plan_type', 'free').not('plan_type', 'is', null),
          sb.from('user_credits').select('balance, lifetime_spent'),
          sb.from('profiles').select('created_at').order('created_at', { ascending: false }).limit(30),
          sb.from('analytics_events').select('*', { count: 'exact', head: true }).gte('created_at', todayStart),
          sb.from('analytics_events').select('*', { count: 'exact', head: true }).gte('created_at', yesterdayStart).lt('created_at', todayStart),
          sb.from('profiles').select('*', { count: 'exact', head: true }).gte('created_at', todayStart),
          sb.from('profiles').select('*', { count: 'exact', head: true }).gte('created_at', yesterdayStart).lt('created_at', todayStart),
          sb.from('prediction_votes').select('*', { count: 'exact', head: true }).gte('created_at', todayStart),
          sb.from('prediction_votes').select('*', { count: 'exact', head: true }).gte('created_at', yesterdayStart).lt('created_at', todayStart),
          sb.from('community_posts').select('*', { count: 'exact', head: true }).gte('created_at', todayStart),
          sb.from('community_posts').select('*', { count: 'exact', head: true }).gte('created_at', yesterdayStart).lt('created_at', todayStart),
          sb.from('credit_transactions').select('amount').gte('created_at', todayStart),
          sb.from('credit_transactions').select('amount').gte('created_at', yesterdayStart).lt('created_at', todayStart),
          sb.from('credit_transactions').select('type, amount, created_at').order('created_at', { ascending: false }).limit(500),
        ]);

        const totalCredits = (credits || []).reduce((s, c) => s + (c.balance || 0), 0);
        const totalSpent = (credits || []).reduce((s, c) => s + (c.lifetime_spent || 0), 0);
        const convRate = totalUsers > 0 ? ((premiumUsers || 0) / totalUsers * 100).toFixed(1) : '0';
        const todayCreditSum = (todayCreditTx || []).reduce((s, t) => s + Math.max(0, t.amount || 0), 0);
        const yesterdayCreditSum = (yesterdayCreditTx || []).reduce((s, t) => s + Math.max(0, t.amount || 0), 0);

        document.getElementById('overview-metrics').innerHTML = `
          <div class="metric-card">
            <div class="metric-label">ì´ ìœ ì €</div>
            <div class="metric-value green">${(totalUsers||0).toLocaleString()}</div>
            ${renderDelta(todaySignups||0, yesterdaySignups||0, 'ëª…')}
            <div class="metric-sub">ì˜¤ëŠ˜ ì‹ ê·œ ${todaySignups||0}ëª…</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">Premium ìœ ì €</div>
            <div class="metric-value yellow">${(premiumUsers||0).toLocaleString()}</div>
            <div class="metric-sub">ì „í™˜ìœ¨ ${convRate}%</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">ì˜¤ëŠ˜ DAU</div>
            <div class="metric-value blue">${(todayDAU||0).toLocaleString()}</div>
            ${renderDelta(todayDAU||0, yesterdayDAU||0, '')}
            <div class="metric-sub">ì–´ì œ ${(yesterdayDAU||0).toLocaleString()}</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">ì˜¤ëŠ˜ ì‹ ê·œê°€ì…</div>
            <div class="metric-value green">${(todaySignups||0).toLocaleString()}</div>
            ${renderDelta(todaySignups||0, yesterdaySignups||0, 'ëª…')}
          </div>
          <div class="metric-card">
            <div class="metric-label">ì˜¤ëŠ˜ íˆ¬í‘œ</div>
            <div class="metric-value blue">${(todayVotes||0).toLocaleString()}</div>
            ${renderDelta(todayVotes||0, yesterdayVotes||0, 'ê±´')}
          </div>
          <div class="metric-card">
            <div class="metric-label">ì˜¤ëŠ˜ ê²Œì‹œê¸€</div>
            <div class="metric-value purple">${(todayPostCount||0).toLocaleString()}</div>
            ${renderDelta(todayPostCount||0, yesterdayPostCount||0, 'ê±´')}
          </div>
          <div class="metric-card">
            <div class="metric-label">ìœ í†µ í¬ë ˆë”§</div>
            <div class="metric-value yellow">${totalCredits.toLocaleString()}C</div>
            ${renderDelta(todayCreditSum, yesterdayCreditSum, 'C')}
            <div class="metric-sub">${(totalCredits*100).toLocaleString()}ì›</div>
          </div>
          <div class="metric-card">
            <div class="metric-label">ì˜ˆìƒ ì›” ë§¤ì¶œ</div>
            <div class="metric-value green">${((premiumUsers||0)*4900).toLocaleString()}ì›</div>
            <div class="metric-sub">Premium ${premiumUsers||0}ëª… Ã— â‚©4,900</div>
          </div>
        `;
        renderSignupChart(recentSignups || []);
        renderCreditFlowChart(creditTx || []);
      } catch (err) {
        console.error('[Overview]', err);
        document.getElementById('overview-metrics').innerHTML = `<div class="empty-state"><p>ë¡œë”© ì‹¤íŒ¨: ${err.message}</p></div>`;
      }
    }

    function renderSignupChart(signups) {
      const days = {};
      signups.forEach(s => { const d = s.created_at?.split('T')[0]; if (d) days[d] = (days[d]||0)+1; });
      const labels = Object.keys(days).reverse();
      if (charts.signups) charts.signups.destroy();
      charts.signups = new Chart(document.getElementById('chart-signups'), {
        type: 'bar',
        data: { labels: labels.map(d=>d.slice(5)), datasets: [{ label:'ê°€ì…ì', data:labels.map(d=>days[d]), backgroundColor:'rgba(76,175,80,0.6)', borderRadius:4 }] },
        options: chartOptions(),
      });
    }

    function renderCreditFlowChart(transactions) {
      const days = {};
      transactions.forEach(tx => {
        const d = tx.created_at?.split('T')[0]; if(!d) return;
        if(!days[d]) days[d]={granted:0,spent:0};
        if(tx.type==='bonus'||tx.type==='purchase') days[d].granted+=tx.amount;
        else if(tx.type==='spend') days[d].spent+=Math.abs(tx.amount);
      });
      const labels = Object.keys(days).sort().slice(-14);
      if (charts.credits) charts.credits.destroy();
      charts.credits = new Chart(document.getElementById('chart-credits'), {
        type: 'line',
        data: { labels: labels.map(d=>d.slice(5)), datasets: [
          { label:'ì§€ê¸‰', data:labels.map(d=>days[d]?.granted||0), borderColor:'#4CAF50', backgroundColor:'rgba(76,175,80,0.1)', fill:true, tension:0.3 },
          { label:'ì†Œë¹„', data:labels.map(d=>days[d]?.spent||0), borderColor:'#CF6679', backgroundColor:'rgba(207,102,121,0.1)', fill:true, tension:0.3 },
        ]},
        options: chartOptions(),
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // USERS (Enhanced)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadUsers() {
      try {
        const { data: profiles, error } = await sb.from('profiles')
          .select('id, email, created_at, plan_type, total_assets, tier, last_active_date, is_banned, current_streak')
          .order('created_at', { ascending: false }).limit(500);
        if (error) throw error;
        const userIds = (profiles||[]).map(p=>p.id);
        const [{ data: creds }, { data: predStats }] = await Promise.all([
          sb.from('user_credits').select('user_id, balance').in('user_id', userIds.slice(0,200)),
          sb.from('prediction_user_stats').select('user_id, accuracy_pct, total_predictions').in('user_id', userIds.slice(0,200)),
        ]);
        const creditMap = {}; (creds||[]).forEach(c => { creditMap[c.user_id]=c.balance; });
        const predMap = {}; (predStats||[]).forEach(p => { predMap[p.user_id]=p; });
        allUsers = (profiles||[]).map(p => ({
          ...p,
          credits: creditMap[p.id]||0,
          accuracy: predMap[p.id]?.accuracy_pct||0,
          predictions: predMap[p.id]?.total_predictions||0,
        }));
        document.getElementById('user-count').textContent = allUsers.length;
        sortAndRenderUsers();
      } catch (err) { console.error('[Users]', err); }
    }

    function sortAndRenderUsers() {
      let sorted = [...allUsers];
      switch(currentUserSort) {
        case 'recent': sorted.sort((a,b) => (b.last_active_date||'') > (a.last_active_date||'') ? 1 : -1); break;
        case 'assets': sorted.sort((a,b) => (b.total_assets||0) - (a.total_assets||0)); break;
        case 'credits': sorted.sort((a,b) => b.credits - a.credits); break;
        case 'created': sorted.sort((a,b) => new Date(b.created_at) - new Date(a.created_at)); break;
      }
      renderUsersTable(sorted);
    }

    function renderUsersTable(users) {
      document.getElementById('users-tbody').innerHTML = users.map(u => `
        <tr class="clickable" onclick="showUserDetail('${u.id}')">
          <td><span class="status-dot ${getActivityDotColor(u.last_active_date)}"></span></td>
          <td>${formatDate(u.created_at)}</td>
          <td>${u.is_banned ? 'ğŸš« ' : ''}${u.email || u.id.slice(0,8)}</td>
          <td><span class="tier-badge ${u.plan_type&&u.plan_type!=='free'?'tier-premium':'tier-free'}">${u.plan_type||'free'}</span></td>
          <td>${u.credits}C</td>
          <td>${u.current_streak||0}ì¼</td>
          <td>${u.predictions>0?`${u.accuracy}% (${u.predictions}íšŒ)`:'-'}</td>
          <td>${u.total_assets?formatKRW(u.total_assets):'-'}</td>
        </tr>
      `).join('');
    }

    function searchUsers(query) {
      const q = query.toLowerCase();
      const filtered = allUsers.filter(u => (u.email&&u.email.toLowerCase().includes(q)) || u.id.toLowerCase().includes(q));
      renderUsersTable(filtered);
    }

    // â”€â”€ User Detail Modal â”€â”€
    async function showUserDetail(userId) {
      showModal('modal-user-detail');
      const body = document.getElementById('modal-user-body');
      body.innerHTML = '<div class="loading-overlay"><div class="spinner"></div> ë¡œë”© ì¤‘...</div>';
      try {
        const [{ data: profile }, { data: creditData }, { data: txData }, { data: predData }, { data: badgeData }, { data: actData }] = await Promise.all([
          sb.from('profiles').select('*').eq('id', userId).single(),
          sb.from('user_credits').select('*').eq('user_id', userId).maybeSingle(),
          sb.from('credit_transactions').select('*').eq('user_id', userId).order('created_at',{ascending:false}).limit(10),
          sb.from('prediction_user_stats').select('*').eq('user_id', userId).maybeSingle(),
          sb.from('user_badges').select('*').eq('user_id', userId),
          sb.from('analytics_events').select('event_name, created_at').eq('user_id', userId).order('created_at',{ascending:false}).limit(20),
        ]);
        document.getElementById('modal-user-name').textContent = profile?.email || userId.slice(0,8);
        body.innerHTML = `
          <div class="modal-section">
            <div class="modal-section-title">ê¸°ë³¸ ì •ë³´</div>
            <div class="info-grid">
              <div><div class="info-label">ì´ë©”ì¼</div><div class="info-value">${profile?.email||'-'}</div></div>
              <div><div class="info-label">í”Œëœ</div><div class="info-value">${profile?.plan_type||'free'}</div></div>
              <div><div class="info-label">í‹°ì–´</div><div class="info-value">${profile?.tier||'SILVER'}</div></div>
              <div><div class="info-label">ê°€ì…ì¼</div><div class="info-value">${formatDate(profile?.created_at)}</div></div>
              <div><div class="info-label">ìµœê·¼ í™œë™</div><div class="info-value"><span class="status-dot ${getActivityDotColor(profile?.last_active_date)}"></span>${profile?.last_active_date||'ì—†ìŒ'}</div></div>
              <div><div class="info-label">ìŠ¤íŠ¸ë¦­</div><div class="info-value">${profile?.current_streak||0}ì¼ (ìµœì¥ ${profile?.longest_streak||0}ì¼)</div></div>
              <div><div class="info-label">ìì‚°</div><div class="info-value">${profile?.total_assets?formatKRW(profile.total_assets):'-'}</div></div>
              <div><div class="info-label">ì°¨ë‹¨ ìƒíƒœ</div><div class="info-value">${profile?.is_banned?'ğŸš« ì°¨ë‹¨ë¨':'ì •ìƒ'}</div></div>
            </div>
          </div>
          <div class="modal-section">
            <div class="modal-section-title">í¬ë ˆë”§</div>
            <div class="info-grid">
              <div><div class="info-label">ì”ì•¡</div><div class="info-value">${creditData?.balance||0}C</div></div>
              <div><div class="info-label">ì´ ì¶©ì „</div><div class="info-value">${creditData?.lifetime_purchased||0}C</div></div>
              <div><div class="info-label">ì´ ì†Œë¹„</div><div class="info-value">${creditData?.lifetime_spent||0}C</div></div>
            </div>
          </div>
          <div class="modal-section">
            <div class="modal-section-title">ì˜ˆì¸¡</div>
            <div class="info-grid">
              <div><div class="info-label">ì´ ì˜ˆì¸¡</div><div class="info-value">${predData?.total_predictions||0}íšŒ</div></div>
              <div><div class="info-label">ì ì¤‘</div><div class="info-value">${predData?.correct_predictions||0}íšŒ (${predData?.accuracy_pct||0}%)</div></div>
            </div>
          </div>
          ${(badgeData||[]).length > 0 ? `<div class="modal-section"><div class="modal-section-title">ë±ƒì§€ (${badgeData.length}ê°œ)</div><div style="display:flex;gap:8px;flex-wrap:wrap;">${badgeData.map(b=>`<span class="tier-badge tier-premium">${b.badge_id}</span>`).join('')}</div></div>` : ''}
          <div class="modal-section">
            <div class="modal-section-title">ìµœê·¼ í™œë™</div>
            ${(actData||[]).length > 0 ? actData.map(a=>`<div class="feed-item"><span class="feed-time">${formatRelativeTime(a.created_at)}</span><span class="feed-event">${a.event_name}</span></div>`).join('') : '<div class="empty-state"><p>í™œë™ ì—†ìŒ</p></div>'}
          </div>
          <div style="display:flex;gap:8px;margin-top:16px;">
            <button class="action-btn ${profile?.is_banned?'success':'danger'}" onclick="toggleBan('${userId}', ${!profile?.is_banned})">
              ${profile?.is_banned ? 'ì°¨ë‹¨ í•´ì œ' : 'ğŸš« ì°¨ë‹¨'}
            </button>
            <button class="action-btn primary" onclick="showCreditGrantModal('${userId}', '${profile?.email||userId.slice(0,8)}')">
              í¬ë ˆë”§ ì§€ê¸‰
            </button>
          </div>
        `;
      } catch (err) {
        body.innerHTML = `<div class="empty-state"><p>ë¡œë”© ì‹¤íŒ¨: ${err.message}</p></div>`;
      }
    }

    async function toggleBan(userId, ban) {
      const action = ban ? 'ì°¨ë‹¨' : 'ì°¨ë‹¨ í•´ì œ';
      if (!confirm(`ì´ ìœ ì €ë¥¼ ${action}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      try {
        const updates = ban ? { is_banned: true, banned_at: new Date().toISOString() } : { is_banned: false, banned_at: null, ban_reason: null };
        const { error } = await sb.from('profiles').update(updates).eq('id', userId);
        if (error) throw error;
        alert(`${action} ì™„ë£Œ`);
        hideModal('modal-user-detail');
        if (tabDataLoaded.users) { tabDataLoaded.users = false; loadUsers(); }
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    // â”€â”€ Credit Grant Modal â”€â”€
    function showCreditGrantModal(userId, userLabel) {
      hideModal('modal-user-detail');
      document.getElementById('credit-grant-user-id').value = userId;
      document.getElementById('credit-grant-user-info').textContent = userLabel;
      document.getElementById('credit-grant-amount').value = '';
      document.getElementById('credit-grant-memo').value = '';
      showModal('modal-credit-grant');
    }

    async function executeGrantCredit() {
      const userId = document.getElementById('credit-grant-user-id').value;
      const amount = parseInt(document.getElementById('credit-grant-amount').value);
      const memo = document.getElementById('credit-grant-memo').value.trim();
      if (!amount || amount <= 0) { alert('ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if (!confirm(`${amount}Cë¥¼ ì§€ê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      try {
        // Get current balance
        const { data: cur } = await sb.from('user_credits').select('balance').eq('user_id', userId).maybeSingle();
        const newBalance = (cur?.balance || 0) + amount;
        // Upsert credits
        await sb.from('user_credits').upsert({ user_id: userId, balance: newBalance }, { onConflict: 'user_id' });
        // Insert transaction
        await sb.from('credit_transactions').insert({
          user_id: userId, type: 'bonus', amount, balance_after: newBalance,
          feature_type: 'admin_grant', description: memo || 'ê´€ë¦¬ì ì§€ê¸‰',
        });
        alert(`${amount}C ì§€ê¸‰ ì™„ë£Œ (ìƒˆ ì”ì•¡: ${newBalance}C)`);
        hideModal('modal-credit-grant');
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CREDITS TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadCredits() {
      try {
        const [{ data: summary }, { data: recentTx }] = await Promise.all([
          sb.from('user_credits').select('balance, lifetime_purchased, lifetime_spent'),
          sb.from('credit_transactions').select('created_at, user_id, type, amount, balance_after, feature_type').order('created_at',{ascending:false}).limit(50),
        ]);
        const total = (summary||[]).reduce((a,c) => ({ balance:a.balance+(c.balance||0), purchased:a.purchased+(c.lifetime_purchased||0), spent:a.spent+(c.lifetime_spent||0) }), {balance:0,purchased:0,spent:0});
        document.getElementById('credit-metrics').innerHTML = `
          <div class="metric-card"><div class="metric-label">ì´ ìœ í†µ ì”ì•¡</div><div class="metric-value green">${total.balance.toLocaleString()}C</div><div class="metric-sub">${(total.balance*100).toLocaleString()}ì›</div></div>
          <div class="metric-card"><div class="metric-label">ì´ êµ¬ë§¤(ì¶©ì „)</div><div class="metric-value blue">${total.purchased.toLocaleString()}C</div></div>
          <div class="metric-card"><div class="metric-label">ì´ ì†Œë¹„</div><div class="metric-value red">${total.spent.toLocaleString()}C</div></div>
          <div class="metric-card"><div class="metric-label">ì†Œë¹„ìœ¨</div><div class="metric-value yellow">${total.balance+total.spent>0?(total.spent/(total.balance+total.spent)*100).toFixed(1):0}%</div></div>
        `;
        document.getElementById('credits-tbody').innerHTML = (recentTx||[]).map(tx => `
          <tr>
            <td>${formatDateTime(tx.created_at)}</td>
            <td>${tx.user_id?.slice(0,8)||'-'}</td>
            <td><span class="tier-badge ${tx.type==='spend'?'tier-free':'tier-premium'}">${txTypeLabel(tx.type)}</span></td>
            <td style="color:${tx.amount>=0?'var(--green)':'var(--red)'}">${tx.amount>0?'+':''}${tx.amount}C</td>
            <td>${tx.balance_after||0}C</td>
            <td>${tx.feature_type||'-'}</td>
          </tr>
        `).join('');
      } catch (err) { console.error('[Credits]', err); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REPORTS TAB (NEW)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadReports() {
      try {
        const { data: reports, error } = await sb.from('community_reports')
          .select('*').order('created_at', { ascending: false }).limit(200);
        if (error) throw error;

        // Get reporter profiles
        const reporterIds = [...new Set((reports||[]).map(r => r.reporter_id).filter(Boolean))];
        let profileMap = {};
        if (reporterIds.length > 0) {
          const { data: profiles } = await sb.from('profiles').select('id, email').in('id', reporterIds.slice(0, 100));
          (profiles||[]).forEach(p => { profileMap[p.id] = p.email || p.id.slice(0,8); });
        }
        allReports = (reports||[]).map(r => ({ ...r, reporter_email: profileMap[r.reporter_id] || r.reporter_id?.slice(0,8) || '-' }));

        // Update counts
        const counts = { all: allReports.length, pending: 0, resolved: 0, rejected: 0 };
        allReports.forEach(r => { if (counts[r.status] !== undefined) counts[r.status]++; });
        document.getElementById('report-count-all').textContent = counts.all;
        document.getElementById('report-count-pending').textContent = counts.pending;
        document.getElementById('report-count-resolved').textContent = counts.resolved;
        document.getElementById('report-count-rejected').textContent = counts.rejected;

        const rate = counts.all > 0 ? ((counts.resolved / counts.all) * 100).toFixed(0) : 0;
        document.getElementById('report-summary').innerHTML = `ì´ <strong>${counts.all}ê±´</strong> | ëŒ€ê¸° <strong>${counts.pending}ê±´</strong> | ì²˜ë¦¬ìœ¨ <strong>${rate}%</strong>`;

        renderReportsTable();
      } catch (err) {
        console.error('[Reports]', err);
        document.getElementById('reports-tbody').innerHTML = `<tr><td colspan="7"><div class="empty-state"><p>ì‹ ê³  ë°ì´í„° ë¡œë”© ì‹¤íŒ¨: ${err.message}</p></div></td></tr>`;
      }
    }

    function renderReportsTable() {
      const filtered = currentReportFilter === 'all' ? allReports : allReports.filter(r => r.status === currentReportFilter);
      document.getElementById('reports-tbody').innerHTML = filtered.length > 0 ? filtered.map(r => {
        const isPending = r.status === 'pending';
        const isUrgent = isPending && (Date.now() - new Date(r.created_at).getTime()) > 86400000;
        const reasonLabels = { spam:'ìŠ¤íŒ¸', inappropriate:'ë¶€ì ì ˆ', abuse:'ìš•ì„¤', misleading:'í—ˆìœ„', illegal:'ë¶ˆë²•', harassment:'ê´´ë¡­í˜', leading:'ìœ ë„', fraud:'ì‚¬ê¸°', other:'ê¸°íƒ€' };
        const statusLabels = { pending:'ëŒ€ê¸°', resolved:'ì²˜ë¦¬', rejected:'ê±°ë¶€' };
        const statusColors = { pending:'var(--yellow)', resolved:'var(--green)', rejected:'var(--text3)' };
        return `<tr class="clickable" onclick="showReportDetail('${r.id}')">
          <td>${formatRelativeTime(r.created_at)}</td>
          <td>${r.reporter_email}</td>
          <td>${r.target_type||'post'} #${(r.target_id||'').slice(0,8)}</td>
          <td>${reasonLabels[r.reason]||r.reason||'-'}</td>
          <td style="color:${statusColors[r.status]||'var(--text3)'}">${statusLabels[r.status]||r.status}</td>
          <td>${isUrgent ? '<span class="urgent-badge">!!</span>' : ''}</td>
          <td>${isPending ? `<button class="action-btn success" onclick="event.stopPropagation();resolveReport('${r.id}','resolved')">ìŠ¹ì¸</button> <button class="action-btn danger" onclick="event.stopPropagation();resolveReport('${r.id}','rejected')">ê±°ë¶€</button>` : '-'}</td>
        </tr>`;
      }).join('') : '<tr><td colspan="7"><div class="empty-state"><p>ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></td></tr>';
    }

    async function showReportDetail(reportId) {
      showModal('modal-report-detail');
      const body = document.getElementById('modal-report-body');
      body.innerHTML = '<div class="loading-overlay"><div class="spinner"></div></div>';
      try {
        const report = allReports.find(r => r.id === reportId);
        if (!report) throw new Error('ì‹ ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        let contentHtml = '-';
        if (report.target_id) {
          const table = report.target_type === 'comment' ? 'community_comments' : 'community_posts';
          const { data: content } = await sb.from(table).select('*').eq('id', report.target_id).maybeSingle();
          contentHtml = content?.content || '(ì‚­ì œë¨)';
        }
        const reasonLabels = { spam:'ìŠ¤íŒ¸', inappropriate:'ë¶€ì ì ˆ', abuse:'ìš•ì„¤', misleading:'í—ˆìœ„', illegal:'ë¶ˆë²•', harassment:'ê´´ë¡­í˜', leading:'ìœ ë„', fraud:'ì‚¬ê¸°', other:'ê¸°íƒ€' };
        body.innerHTML = `
          <div class="modal-section"><div class="modal-section-title">ì‹ ê³  ì •ë³´</div>
            <div class="info-grid">
              <div><div class="info-label">ì‹ ê³ ì</div><div class="info-value">${report.reporter_email}</div></div>
              <div><div class="info-label">ì‚¬ìœ </div><div class="info-value">${reasonLabels[report.reason]||report.reason}</div></div>
              <div><div class="info-label">ëŒ€ìƒ</div><div class="info-value">${report.target_type||'post'}</div></div>
              <div><div class="info-label">ì‹œê°„</div><div class="info-value">${formatRelativeTime(report.created_at)}</div></div>
            </div>
            ${report.description ? `<div style="margin-top:8px;padding:10px;background:var(--surface);border-radius:8px;font-size:13px;">${report.description}</div>` : ''}
          </div>
          <div class="modal-section"><div class="modal-section-title">ì‹ ê³ ëœ ì½˜í…ì¸ </div>
            <div style="padding:12px;background:var(--surface);border-radius:8px;font-size:14px;line-height:1.5;">${contentHtml}</div>
          </div>
          ${report.status === 'pending' ? `<div style="display:flex;gap:8px;margin-top:16px;">
            <button class="action-btn success" onclick="resolveReport('${report.id}','resolved');hideModal('modal-report-detail')">ìŠ¹ì¸ (ì²˜ë¦¬)</button>
            <button class="action-btn danger" onclick="resolveReport('${report.id}','rejected');hideModal('modal-report-detail')">ê±°ë¶€</button>
            <button class="action-btn danger" onclick="deleteReportedContent('${report.target_id}','${report.target_type||'post'}','${report.id}')">ì½˜í…ì¸  ì‚­ì œ</button>
          </div>` : `<div style="margin-top:16px;color:var(--text3);">ì´ë¯¸ ì²˜ë¦¬ëœ ì‹ ê³ ì…ë‹ˆë‹¤ (${report.status})</div>`}
        `;
      } catch (err) {
        body.innerHTML = `<div class="empty-state"><p>${err.message}</p></div>`;
      }
    }

    async function resolveReport(reportId, status) {
      try {
        const { error } = await sb.from('community_reports').update({ status, updated_at: new Date().toISOString() }).eq('id', reportId);
        if (error) throw error;
        const r = allReports.find(r => r.id === reportId);
        if (r) r.status = status;
        renderReportsTable();
        // Update counts
        const counts = { all: allReports.length, pending: 0, resolved: 0, rejected: 0 };
        allReports.forEach(r => { if (counts[r.status] !== undefined) counts[r.status]++; });
        document.getElementById('report-count-all').textContent = counts.all;
        document.getElementById('report-count-pending').textContent = counts.pending;
        document.getElementById('report-count-resolved').textContent = counts.resolved;
        document.getElementById('report-count-rejected').textContent = counts.rejected;
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    async function deleteReportedContent(targetId, targetType, reportId) {
      if (!confirm('ì´ ì½˜í…ì¸ ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const table = targetType === 'comment' ? 'community_comments' : 'community_posts';
        const { error } = await sb.from(table).delete().eq('id', targetId);
        if (error) throw error;
        await resolveReport(reportId, 'resolved');
        hideModal('modal-report-detail');
        alert('ì½˜í…ì¸ ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LOUNGE TAB (NEW)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadLoungePosts() {
      try {
        const { data: posts, error } = await sb.from('community_posts')
          .select('*').order('created_at', { ascending: false }).limit(200);
        if (error) throw error;
        const userIds = [...new Set((posts||[]).map(p => p.user_id).filter(Boolean))];
        let profileMap = {};
        if (userIds.length > 0) {
          const { data: profiles } = await sb.from('profiles').select('id, email').in('id', userIds.slice(0, 100));
          (profiles||[]).forEach(p => { profileMap[p.id] = p.email || p.id.slice(0,8); });
        }
        allPosts = (posts||[]).map(p => ({ ...p, author_email: profileMap[p.user_id] || p.user_id?.slice(0,8) || '-' }));
        document.getElementById('lounge-post-count').textContent = allPosts.length;
        if (currentLoungeSegment === 'posts') renderLoungeContent();
      } catch (err) { console.error('[Lounge Posts]', err); }
    }

    async function loadGatherings() {
      try {
        const { data: gatherings, error } = await sb.from('gatherings')
          .select('*').order('created_at', { ascending: false }).limit(100);
        if (error) throw error;
        allGatherings = gatherings || [];
        document.getElementById('lounge-gathering-count').textContent = allGatherings.length;
        if (currentLoungeSegment === 'gatherings') renderLoungeContent();
      } catch (err) { console.error('[Gatherings]', err); }
    }

    function renderLoungeContent() {
      const container = document.getElementById('lounge-content');
      selectedPosts = new Set();
      updateBulkBar();

      if (currentLoungeSegment === 'posts') {
        const activeFilter = document.querySelector('#lounge-filters .filter-chip.active')?.dataset.filter || 'all';
        let filtered = allPosts;
        if (activeFilter === 'pinned') filtered = allPosts.filter(p => p.is_pinned);
        if (activeFilter === 'reported') filtered = allPosts.filter(p => (p.report_count||0) > 0);

        container.innerHTML = filtered.length > 0 ? filtered.map(p => `
          <div class="post-card" data-post-id="${p.id}">
            <div class="post-card-header">
              <div style="display:flex;align-items:center;gap:8px;">
                <input type="checkbox" onchange="togglePostSelect('${p.id}', this.checked)" />
                <span class="post-card-meta">${p.author_email} Â· ${formatRelativeTime(p.created_at)}</span>
                ${p.is_pinned ? '<span class="tier-badge tier-premium">ğŸ“Œ ê³ ì •</span>' : ''}
                ${(p.report_count||0)>0 ? `<span class="urgent-badge">ì‹ ê³  ${p.report_count}</span>` : ''}
              </div>
              <span class="post-card-meta">${p.category||''} Â· ì¢‹ì•„ìš” ${p.likes_count||0} Â· ëŒ“ê¸€ ${p.comments_count||0}</span>
            </div>
            <div class="post-card-content">${(p.content||'').slice(0,200)}${(p.content||'').length>200?'...':''}</div>
            <div class="post-actions">
              <button class="action-btn ${p.is_pinned?'':'success'}" onclick="togglePin('${p.id}', ${!p.is_pinned})">${p.is_pinned?'ê³ ì • í•´ì œ':'ğŸ“Œ ê³ ì •'}</button>
              <button class="action-btn danger" onclick="deletePost('${p.id}')">ì‚­ì œ</button>
            </div>
          </div>
        `).join('') : '<div class="empty-state"><p>ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
      } else {
        const statusLabels = { open:'ëª¨ì§‘ì¤‘', closed:'ë§ˆê°', cancelled:'ì·¨ì†Œ', completed:'ì™„ë£Œ' };
        const statusColors = { open:'var(--green)', closed:'var(--yellow)', cancelled:'var(--red)', completed:'var(--text3)' };
        container.innerHTML = allGatherings.length > 0 ? allGatherings.map(g => `
          <div class="post-card">
            <div class="post-card-header">
              <div>
                <strong>${g.title||'(ì œëª© ì—†ìŒ)'}</strong>
                <span style="color:${statusColors[g.status]||'var(--text3)'};font-size:12px;margin-left:8px;">${statusLabels[g.status]||g.status}</span>
              </div>
              <span class="post-card-meta">${g.category||''} Â· ${g.location_type||'offline'}</span>
            </div>
            <div class="post-card-content">${g.description||'-'}</div>
            <div class="post-card-meta" style="margin-bottom:8px;">ì°¸ì—¬ ${g.current_capacity||0}/${g.max_capacity||0} Â· ${g.location||'-'} Â· ${g.event_date ? new Date(g.event_date).toLocaleDateString('ko') : '-'}</div>
            <div class="post-actions">
              ${g.status==='open' ? `<button class="action-btn danger" onclick="cancelGathering('${g.id}')">ì·¨ì†Œ</button>` : ''}
            </div>
          </div>
        `).join('') : '<div class="empty-state"><p>ëª¨ì„ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
      }
    }

    function togglePostSelect(postId, checked) {
      if (checked) selectedPosts.add(postId); else selectedPosts.delete(postId);
      updateBulkBar();
    }

    function updateBulkBar() {
      const bar = document.getElementById('bulk-actions');
      if (selectedPosts.size > 0) { bar.classList.remove('hidden'); document.getElementById('bulk-count').textContent = `${selectedPosts.size}ê°œ ì„ íƒ`; }
      else { bar.classList.add('hidden'); }
    }

    async function togglePin(postId, pin) {
      try {
        const { error } = await sb.from('community_posts').update({ is_pinned: pin }).eq('id', postId);
        if (error) throw error;
        const p = allPosts.find(p => p.id === postId); if (p) p.is_pinned = pin;
        renderLoungeContent();
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    async function deletePost(postId) {
      if (!confirm('ì´ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const { error } = await sb.from('community_posts').delete().eq('id', postId);
        if (error) throw error;
        allPosts = allPosts.filter(p => p.id !== postId);
        document.getElementById('lounge-post-count').textContent = allPosts.length;
        renderLoungeContent();
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    async function cancelGathering(gatheringId) {
      if (!confirm('ì´ ëª¨ì„ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      try {
        const { error } = await sb.from('gatherings').update({ status: 'cancelled' }).eq('id', gatheringId);
        if (error) throw error;
        const g = allGatherings.find(g => g.id === gatheringId); if (g) g.status = 'cancelled';
        renderLoungeContent();
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    async function bulkPin() {
      if (!confirm(`${selectedPosts.size}ê°œ ê²Œì‹œê¸€ì„ ê³ ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
      try {
        for (const id of selectedPosts) {
          await sb.from('community_posts').update({ is_pinned: true }).eq('id', id);
          const p = allPosts.find(p => p.id === id); if (p) p.is_pinned = true;
        }
        selectedPosts.clear(); renderLoungeContent();
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    async function bulkDelete() {
      if (!confirm(`${selectedPosts.size}ê°œ ê²Œì‹œê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) return;
      try {
        for (const id of selectedPosts) {
          await sb.from('community_posts').delete().eq('id', id);
        }
        allPosts = allPosts.filter(p => !selectedPosts.has(p.id));
        document.getElementById('lounge-post-count').textContent = allPosts.length;
        selectedPosts.clear(); renderLoungeContent();
      } catch (err) { alert(`ì‹¤íŒ¨: ${err.message}`); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ENGAGEMENT TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadEngagement() {
      try {
        const [{ data: predStats }, { count: totalVotes }, { data: badges }, { data: recentPolls }] = await Promise.all([
          sb.from('prediction_user_stats').select('accuracy_pct, total_predictions, correct_predictions'),
          sb.from('prediction_votes').select('*', { count: 'exact', head: true }),
          sb.from('user_badges').select('badge_id'),
          sb.from('prediction_polls').select('*').order('date', { ascending: false }).limit(7),
        ]);
        const avgAcc = (predStats||[]).length > 0 ? ((predStats||[]).reduce((s,p)=>s+(p.accuracy_pct||0),0)/predStats.length).toFixed(1) : 0;
        const badgeCounts = {}; (badges||[]).forEach(b => { badgeCounts[b.badge_id]=(badgeCounts[b.badge_id]||0)+1; });
        document.getElementById('engagement-metrics').innerHTML = `
          <div class="metric-card"><div class="metric-label">ì´ ì˜ˆì¸¡ íˆ¬í‘œ</div><div class="metric-value blue">${(totalVotes||0).toLocaleString()}</div></div>
          <div class="metric-card"><div class="metric-label">í‰ê·  ì ì¤‘ë¥ </div><div class="metric-value green">${avgAcc}%</div><div class="metric-sub">${(predStats||[]).length}ëª… ì°¸ì—¬</div></div>
          <div class="metric-card"><div class="metric-label">ë°œê¸‰ëœ ë±ƒì§€</div><div class="metric-value yellow">${(badges||[]).length}</div><div class="metric-sub">${Object.keys(badgeCounts).length}ì¢…</div></div>
          <div class="metric-card"><div class="metric-label">ìµœê·¼ í€´ì¦ˆ/ì˜ˆì¸¡</div><div class="metric-value">${(recentPolls||[]).length}</div><div class="metric-sub">ìµœê·¼ 7ì¼</div></div>
        `;
        renderPredictionChart(recentPolls||[]);
        renderStreakChart(predStats||[]);
      } catch (err) { console.error('[Engagement]', err); }
    }

    function renderPredictionChart(polls) {
      const labels = polls.map(p=>p.date?.slice(5)||'?').reverse();
      if (charts.predictions) charts.predictions.destroy();
      charts.predictions = new Chart(document.getElementById('chart-predictions'), {
        type:'bar', data:{labels, datasets:[{label:'ì˜ˆì¸¡ ì§ˆë¬¸',data:labels.map(()=>1),backgroundColor:'rgba(33,150,243,0.6)',borderRadius:4}]}, options:chartOptions(),
      });
    }

    function renderStreakChart(predStats) {
      const ranges = {'0-5':0,'6-20':0,'21-50':0,'51-100':0,'100+':0};
      predStats.forEach(p => { const t=p.total_predictions||0; if(t<=5)ranges['0-5']++;else if(t<=20)ranges['6-20']++;else if(t<=50)ranges['21-50']++;else if(t<=100)ranges['51-100']++;else ranges['100+']++; });
      if (charts.streaks) charts.streaks.destroy();
      charts.streaks = new Chart(document.getElementById('chart-streaks'), {
        type:'doughnut', data:{labels:Object.keys(ranges), datasets:[{data:Object.values(ranges),backgroundColor:['#9E9E9E','#2196F3','#4CAF50','#FFC107','#CF6679']}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#9E9E9E',padding:12}}}},
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONTENT TAB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadContent() {
      try {
        const [{ data: cards, count: cardCount }, { count: postCount }, { count: quizCount }] = await Promise.all([
          sb.from('context_cards').select('*', { count:'exact' }).order('date',{ascending:false}).limit(20),
          sb.from('community_posts').select('*', { count:'exact', head:true }),
          sb.from('daily_quizzes').select('*', { count:'exact', head:true }),
        ]);
        document.getElementById('content-metrics').innerHTML = `
          <div class="metric-card"><div class="metric-label">ë§¥ë½ ì¹´ë“œ</div><div class="metric-value green">${cardCount||0}</div></div>
          <div class="metric-card"><div class="metric-label">ì»¤ë®¤ë‹ˆí‹° ê²Œì‹œê¸€</div><div class="metric-value blue">${(postCount||0).toLocaleString()}</div></div>
          <div class="metric-card"><div class="metric-label">í€´ì¦ˆ</div><div class="metric-value yellow">${quizCount||0}</div></div>
        `;
        document.getElementById('context-tbody').innerHTML = (cards||[]).map(c => `
          <tr><td>${c.date||'-'}</td><td>${c.headline||'(ì œëª© ì—†ìŒ)'}</td><td><span class="tier-badge ${c.sentiment==='calm'?'tier-premium':'tier-free'}">${c.sentiment||'-'}</span></td><td>-</td></tr>
        `).join('');
      } catch (err) { console.error('[Content]', err); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ANALYTICS TAB (Enhanced)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadEnhancedAnalytics() {
      try {
        // Fetch data for retention, trends, distributions
        const now = new Date();
        const d7ago = new Date(now.getTime() - 7*86400000).toISOString();

        const [{ data: allProfiles }, { data: recentEvents }] = await Promise.all([
          sb.from('profiles').select('id, created_at, last_active_date, tier, plan_type, total_assets'),
          sb.from('analytics_events').select('user_id, created_at').gte('created_at', d7ago).limit(5000),
        ]);

        // â”€â”€ Retention â”€â”€
        const retentionEl = document.getElementById('retention-bars');
        const profiles = allProfiles || [];
        const computeRetention = (days) => {
          const cutoff = new Date(now.getTime() - days*86400000);
          const eligible = profiles.filter(p => new Date(p.created_at) <= cutoff);
          if (eligible.length === 0) return { rate: 0, eligible: 0, retained: 0 };
          const retained = eligible.filter(p => {
            if (!p.last_active_date) return false;
            const signup = new Date(p.created_at);
            const lastActive = new Date(p.last_active_date);
            return (lastActive - signup) >= days * 86400000;
          });
          return { rate: (retained.length / eligible.length * 100).toFixed(1), eligible: eligible.length, retained: retained.length };
        };
        const d1 = computeRetention(1), d7 = computeRetention(7), d30 = computeRetention(30);
        const retentionColors = (rate) => rate >= 40 ? '#4CAF50' : rate >= 20 ? '#FFC107' : '#CF6679';
        retentionEl.innerHTML = [
          { label: 'D1 ë¦¬í…ì…˜', ...d1 },
          { label: 'D7 ë¦¬í…ì…˜', ...d7 },
          { label: 'D30 ë¦¬í…ì…˜', ...d30 },
        ].map(r => `
          <div class="retention-bar">
            <label><span>${r.label} (${r.retained}/${r.eligible}ëª…)</span><span>${r.rate}%</span></label>
            <div class="retention-track"><div class="retention-fill" style="width:${Math.max(r.rate,3)}%;background:${retentionColors(parseFloat(r.rate))};">${r.rate}%</div></div>
          </div>
        `).join('');

        // â”€â”€ 7-day Trend â”€â”€
        const trendDays = [];
        for (let i = 6; i >= 0; i--) {
          const d = new Date(now.getFullYear(), now.getMonth(), now.getDate() - i);
          trendDays.push(d.toISOString().split('T')[0]);
        }
        const signupsByDay = {}; profiles.forEach(p => { const d = p.created_at?.split('T')[0]; if (d) signupsByDay[d] = (signupsByDay[d]||0)+1; });
        const dauByDay = {};
        (recentEvents||[]).forEach(e => {
          const d = e.created_at?.split('T')[0];
          if (!d) return;
          if (!dauByDay[d]) dauByDay[d] = new Set();
          dauByDay[d].add(e.user_id);
        });

        if (charts.trend) charts.trend.destroy();
        charts.trend = new Chart(document.getElementById('chart-trend'), {
          type: 'bar',
          data: {
            labels: trendDays.map(d => d.slice(5)),
            datasets: [
              { label: 'ê°€ì…', data: trendDays.map(d => signupsByDay[d]||0), backgroundColor: 'rgba(76,175,80,0.6)', borderRadius: 4, order: 2 },
              { label: 'DAU', data: trendDays.map(d => dauByDay[d]?.size||0), type: 'line', borderColor: '#2196F3', backgroundColor: 'rgba(33,150,243,0.1)', fill: true, tension: 0.3, order: 1 },
            ],
          },
          options: chartOptions(),
        });

        // â”€â”€ Distributions â”€â”€
        // Tier
        const tierCounts = {}; profiles.forEach(p => { const t = p.tier||'SILVER'; tierCounts[t]=(tierCounts[t]||0)+1; });
        if (charts.tierDist) charts.tierDist.destroy();
        charts.tierDist = new Chart(document.getElementById('chart-tier-dist'), {
          type:'doughnut', data:{labels:Object.keys(tierCounts), datasets:[{data:Object.values(tierCounts),backgroundColor:['#9E9E9E','#FFC107','#E0E0E0','#2196F3']}]},
          options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}},
        });
        // Plan
        const planCounts = {}; profiles.forEach(p => { const pl = p.plan_type||'free'; planCounts[pl]=(planCounts[pl]||0)+1; });
        if (charts.planDist) charts.planDist.destroy();
        charts.planDist = new Chart(document.getElementById('chart-plan-dist'), {
          type:'doughnut', data:{labels:Object.keys(planCounts), datasets:[{data:Object.values(planCounts),backgroundColor:['#9E9E9E','#FFC107','#4CAF50']}]},
          options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}},
        });
        // Asset ranges
        const assetRanges = {'0':0,'~1ì²œë§Œ':0,'~5ì²œë§Œ':0,'~1ì–µ':0,'~5ì–µ':0,'5ì–µ+':0};
        profiles.forEach(p => {
          const a = p.total_assets||0;
          if(a<=0)assetRanges['0']++;else if(a<=10000000)assetRanges['~1ì²œë§Œ']++;else if(a<=50000000)assetRanges['~5ì²œë§Œ']++;else if(a<=100000000)assetRanges['~1ì–µ']++;else if(a<=500000000)assetRanges['~5ì–µ']++;else assetRanges['5ì–µ+']++;
        });
        if (charts.assetDist) charts.assetDist.destroy();
        charts.assetDist = new Chart(document.getElementById('chart-asset-dist'), {
          type:'doughnut', data:{labels:Object.keys(assetRanges), datasets:[{data:Object.values(assetRanges),backgroundColor:['#666','#9E9E9E','#2196F3','#4CAF50','#FFC107','#CF6679']}]},
          options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}}},
        });

        // â”€â”€ Activity Feed â”€â”€
        const feedEl = document.getElementById('activity-feed');
        const events = recentEvents || [];
        const groups = { now: [], hour: [], today: [], yesterday: [], older: [] };
        events.slice(0, 50).forEach(e => {
          const diff = Date.now() - new Date(e.created_at).getTime();
          if (diff < 300000) groups.now.push(e);
          else if (diff < 3600000) groups.hour.push(e);
          else if (diff < 86400000) groups.today.push(e);
          else if (diff < 172800000) groups.yesterday.push(e);
          else groups.older.push(e);
        });
        const groupLabels = { now: 'ë°©ê¸ˆ', hour: '1ì‹œê°„ ì´ë‚´', today: 'ì˜¤ëŠ˜', yesterday: 'ì–´ì œ', older: 'ì´ì „' };
        feedEl.innerHTML = Object.entries(groups).filter(([,items]) => items.length > 0).map(([key, items]) => `
          <div class="feed-group">
            <div class="feed-group-label">${groupLabels[key]} (${items.length})</div>
            ${items.slice(0, 10).map(e => `<div class="feed-item"><span class="feed-time">${formatRelativeTime(e.created_at)}</span><span class="feed-event"><strong>${e.user_id?.slice(0,6)||'anon'}</strong></span></div>`).join('')}
          </div>
        `).join('') || '<div class="empty-state"><p>í™œë™ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
      } catch (err) {
        console.error('[Analytics]', err);
        document.getElementById('retention-bars').innerHTML = `<div class="empty-state"><p>ë¶„ì„ ë¡œë”© ì‹¤íŒ¨: ${err.message}</p></div>`;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EVENT LOG TAB (renamed from old Analytics)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function loadEventLog() {
      try {
        const { data: events } = await sb.from('analytics_events')
          .select('created_at, user_id, event_name, properties')
          .order('created_at', { ascending: false }).limit(100);
        document.getElementById('eventlog-tbody').innerHTML = (events||[]).map(e => `
          <tr>
            <td>${formatDateTime(e.created_at)}</td>
            <td>${e.user_id?.slice(0,8)||'anon'}</td>
            <td><strong>${e.event_name}</strong></td>
            <td style="font-size:11px;color:var(--text3);max-width:300px;overflow:hidden;text-overflow:ellipsis;">${JSON.stringify(e.properties||{}).slice(0,80)}</td>
          </tr>
        `).join('') || '<tr><td colspan="4"><div class="empty-state"><p>ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</p></div></td></tr>';
      } catch (err) { console.error('[EventLog]', err); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODAL SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showModal(id) { document.getElementById(id).classList.add('visible'); }
    function hideModal(id) { document.getElementById(id).classList.remove('visible'); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderDelta(today, yesterday, suffix) {
      const diff = today - yesterday;
      if (diff > 0) return `<div class="metric-delta up">â–² +${diff.toLocaleString()}${suffix}</div>`;
      if (diff < 0) return `<div class="metric-delta down">â–¼ ${diff.toLocaleString()}${suffix}</div>`;
      return `<div class="metric-delta flat">â€” 0${suffix}</div>`;
    }

    function getActivityDotColor(lastActiveDate) {
      if (!lastActiveDate) return 'red';
      const diffDays = Math.floor((Date.now() - new Date(lastActiveDate).getTime()) / 86400000);
      if (diffDays <= 1) return 'green';
      if (diffDays <= 7) return 'yellow';
      return 'gray';
    }

    function formatRelativeTime(iso) {
      if (!iso) return '-';
      const diff = Date.now() - new Date(iso).getTime();
      if (diff < 60000) return 'ë°©ê¸ˆ';
      if (diff < 3600000) return `${Math.floor(diff/60000)}ë¶„ ì „`;
      if (diff < 86400000) return `${Math.floor(diff/3600000)}ì‹œê°„ ì „`;
      if (diff < 172800000) return 'ì–´ì œ';
      return `${Math.floor(diff/86400000)}ì¼ ì „`;
    }

    function formatDate(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return `${d.getMonth()+1}/${d.getDate()}`;
    }

    function formatDateTime(iso) {
      if (!iso) return '-';
      const d = new Date(iso);
      return `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${String(d.getMinutes()).padStart(2,'0')}`;
    }

    function formatKRW(amount) {
      if (!amount) return '-';
      if (amount >= 100000000) return `${(amount/100000000).toFixed(1)}ì–µ`;
      if (amount >= 10000) return `${(amount/10000).toFixed(0)}ë§Œì›`;
      return `${amount.toLocaleString()}ì›`;
    }

    function txTypeLabel(type) {
      return { bonus:'ì§€ê¸‰', spend:'ì†Œë¹„', purchase:'ì¶©ì „', refund:'í™˜ë¶ˆ' }[type] || type;
    }

    function chartOptions() {
      return {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: {
          x: { ticks: { color: '#666' }, grid: { color: 'rgba(51,51,51,0.5)' } },
          y: { ticks: { color: '#666' }, grid: { color: 'rgba(51,51,51,0.5)' } },
        },
      };
    }
  </script>
</body>
</html>
